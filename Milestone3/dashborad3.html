<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crowd Count Dashboard - M3</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --blue:#0b78ff;
      --sidebar-bg: #ffffff;
      --page-bg: #f4f6fb;
    }

    html,body { height:100%; margin:0; }
    body { background:var(--page-bg); font-family: Inter, system-ui, Arial; }

    .topbar {
      height:56px;
      background:var(--blue);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      position:fixed; left:0; right:0; top:0;
    }

    .layout {
      display:flex;
      height: calc(100vh - 56px);
      margin-top:56px;
    }

    .sidebar {
      width:260px;
      background:white;
      border-right:1px solid #eee;
      padding:20px;
    }

    .nav-link {
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      margin-bottom:10px;
      border-radius:10px;
      text-decoration:none;
      color:black;
      background:white;
      border:1px solid #eee;
    }

    .nav-link.active {
      background:#e8f0ff;
      border-color:#b5d0ff;
      color:#0b78ff;
      font-weight:600;
    }

    .main {
      flex:1;
      padding:20px;
      overflow:auto;
    }

    .card {
      background:white;
      padding:20px;
      border-radius:12px;
      margin-bottom:20px;
    }

    .media-box {
      border-radius:10px;
      border:3px solid #e6eefc;
      width:100%;
      max-height:500px;
      object-fit:cover;
      background:black;
    }

    .counts-list li {
      list-style:none;
      margin-bottom:5px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color:white;
      padding:20px;
      border-radius:12px;
      text-align:center;
    }

    .chart-container {
      height:300px;
      margin-top:20px;
    }

  </style>
</head>
<body>

<div class="topbar">
  <div class="title"><i class="bi bi-geo-fill"></i> Crowd Count</div>
  <div class="user">
    Welcome, <strong>{{ user.name }}</strong>
    <a href="/logout" class="btn btn-light btn-sm">Logout</a>
  </div>
</div>

<div class="layout">

  <aside class="sidebar">
    <a class="nav-link active" onclick="switchTab('home', this)">
      <i class="bi bi-house-door-fill"></i> Home
    </a>

    <a class="nav-link" onclick="switchTab('live', this)">
      <i class="bi bi-camera-video-fill"></i> Live Webcam
    </a>

    <a class="nav-link" onclick="switchTab('image', this)">
      <i class="bi bi-image-fill"></i> Upload Image
    </a>

    <a class="nav-link" onclick="switchTab('video', this)">
      <i class="bi bi-film"></i> Upload Video
    </a>

    <a class="nav-link" onclick="switchTab('profile', this)">
      <i class="bi bi-person-circle"></i> Profile
    </a>

    <a href="/logout" class="nav-link">
      <i class="bi bi-box-arrow-right"></i> Logout
    </a>
  </aside>

  <main class="main">

    <section id="home" class="tab" style="display:block;">
      <div class="card">
        <h4>Welcome, {{ user.name }}</h4>
        <p>This dashboard shows live people detection and analytics.</p>

        <div class="row">
          <div class="col-md-4">
            <div class="stat-card">
              <p>Total People Right Now</p>
              <h2 id="homeCount">0</h2>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="live" class="tab" style="display:none;">
      <div class="card">
        <h5><i class="bi bi-camera-video-fill"></i> Live Webcam Feed</h5>

        <div class="mt-3">
          <button id="startBtn" class="btn btn-success btn-sm"><i class="bi bi-play-fill"></i> Start</button>
          <button id="stopBtn" class="btn btn-danger btn-sm"><i class="bi bi-stop-fill"></i> Stop</button>
          <button id="captureBtn" class="btn btn-warning btn-sm"><i class="bi bi-camera"></i> Capture</button>
        </div>

        <div class="mt-3">
          <img id="liveFeed" class="media-box" src="{{ url_for('video_feed') }}">
        </div>

        <div class="row mt-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h6><strong>Detected Objects (Live)</strong></h6>
              <ul id="liveCounts" class="counts-list">
                <li>No data</li>
              </ul>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3 text-center">
              <h6><strong>People Count</strong></h6>
              <div id="livePeople" style="font-size:48px; font-weight:700; color:var(--blue);">0</div>
            </div>
          </div>
        </div>
      </div>

      <h6 class="mt-4"><i class="bi bi-graph-up"></i> People Count Over Time</h6>
      <div class="chart-container"><canvas id="lineChartLive"></canvas></div>

      <h6 class="mt-4"><i class="bi bi-activity"></i> Crowd Density</h6>
      <div class="chart-container"><canvas id="heatChartLive"></canvas></div>

      <h6 class="mt-4"><i class="bi bi-columns-gap"></i> Zone Distribution</h6>
      <div class="chart-container"><canvas id="barChartLive"></canvas></div>
    </section>
        <!-- IMAGE SECTION -->
    <section id="image" class="tab" style="display:none;">
      <div class="card p-3">
        <h5><i class="bi bi-image-fill"></i> Upload Image for Detection</h5>

        <form id="imageForm" class="mt-3" enctype="multipart/form-data">
          <input type="file" name="image" accept="image/*" required class="form-control mb-3">
          <button class="btn btn-primary"><i class="bi bi-search"></i> Upload & Detect</button>
        </form>

        <div id="imageResult" class="mt-4"></div>
      </div>

      <h6 class="mt-4"><i class="bi bi-graph-up"></i> People Count Over Time (Image)</h6>
      <div class="chart-container"><canvas id="lineChartImg"></canvas></div>

      <h6 class="mt-4"><i class="bi bi-activity"></i> Crowd Density (Image)</h6>
      <div class="chart-container"><canvas id="heatChartImg"></canvas></div>

      <h6 class="mt-4"><i class="bi bi-columns-gap"></i> Zone Distribution (Image)</h6>
      <div class="chart-container"><canvas id="barChartImg"></canvas></div>
    </section>

    <!-- VIDEO SECTION -->
    <section id="video" class="tab" style="display:none;">
      <div class="card p-3">
        <h5><i class="bi bi-film"></i> Upload Video for Detection</h5>

        <form id="videoFormMain" class="mt-3" enctype="multipart/form-data">
          <input type="file" name="video" accept="video/*" required class="form-control mb-3">
          <button class="btn btn-primary"><i class="bi bi-search"></i> Upload & Process</button>
        </form>

        <div id="videoResult" class="mt-4"></div>
      </div>

      <h6 class="mt-4"><i class="bi bi-graph-up"></i> People Count Over Time (Video)</h6>
      <div class="chart-container"><canvas id="lineChartVid"></canvas></div>

      <h6 class="mt-4"><i class="bi bi-activity"></i> Crowd Density (Video)</h6>
      <div class="chart-container"><canvas id="heatChartVid"></canvas></div>

      <h6 class="mt-4"><i class="bi bi-columns-gap"></i> Zone Distribution (Video)</h6>
      <div class="chart-container"><canvas id="barChartVid"></canvas></div>
    </section>

    <!-- PROFILE SECTION -->
    <section id="profile" class="tab" style="display:none;">
      <div class="card p-4">
        <h5><i class="bi bi-person-circle"></i> User Profile</h5>
        <hr>
        <p><strong>Name:</strong> {{ user.name }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
        <hr>
        <a href="/logout" class="btn btn-danger">Logout</a>
      </div>
    </section>
  </main>
</div>

<script>
  const GET_COUNTS = '/get_counts';
  const START_DET = '/start_detection';
  const STOP_DET = '/stop_detection';
  const CAPTURE = '/capture';
  const UPLOAD_IMAGE = '/api/upload_image';
  const UPLOAD_VIDEO = '/api/upload_video';

  function switchTab(id, el) {
    document.querySelectorAll('.tab').forEach(t => t.style.display = "none");
    document.querySelectorAll('.nav-link').forEach(n => n.classList.remove("active"));

    document.getElementById(id).style.display = "block";
    el.classList.add("active");
  }

  function createLineChart(ctx, label) {
    return new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [{ label, data: [], tension: 0.4 }] },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  function createScatterChart(ctx) {
    return new Chart(ctx, {
      type: "scatter",
      data: { datasets: [{ label: "Density", data: [] }] },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  function createBarChart(ctx) {
    return new Chart(ctx, {
      type: "bar",
      data: { labels: ["Zone 1", "Zone 2", "Zone 3"], datasets: [{ label: "People", data: [0, 0, 0] }] },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  const lineLive = createLineChart(document.getElementById("lineChartLive"), "People Count");
  const heatLive = createScatterChart(document.getElementById("heatChartLive"));
  const barLive = createBarChart(document.getElementById("barChartLive"));

  const lineImg = createLineChart(document.getElementById("lineChartImg"), "Image Count");
  const heatImg = createScatterChart(document.getElementById("heatChartImg"));
  const barImg = createBarChart(document.getElementById("barChartImg"));

  const lineVid = createLineChart(document.getElementById("lineChartVid"), "Video Count");
  const heatVid = createScatterChart(document.getElementById("heatChartVid"));
  const barVid = createBarChart(document.getElementById("barChartVid"));

  let liveTimes = [], liveCounts = [];
  let imgTimes = [], imgCounts = [];
  let vidTimes = [], vidCounts = [];

  async function pollCounts() {
    try {
      const r = await fetch(GET_COUNTS);
      const data = await r.json();

      let people = data.count || 0;
      document.getElementById("homeCount").textContent = people;
      document.getElementById("livePeople").textContent = people;

      let countsHTML = Object.entries(data.details || {})
        .map(([k, v]) => `<li><strong>${k}</strong>: ${v}</li>`).join("");

      document.getElementById("liveCounts").innerHTML = countsHTML || "<li>No objects</li>";

      let now = new Date().toLocaleTimeString();
      liveTimes.push(now);
      liveCounts.push(people);

      if (liveTimes.length > 20) { liveTimes.shift(); liveCounts.shift(); }

      lineLive.data.labels = liveTimes;
      lineLive.data.datasets[0].data = liveCounts;
      lineLive.update();
    } catch {}
  }

  setInterval(pollCounts, 2000);
  pollCounts();

  document.getElementById("startBtn").onclick = () => fetch(START_DET, { method: "POST" });
  document.getElementById("stopBtn").onclick = () => fetch(STOP_DET, { method: "POST" });

  document.getElementById("captureBtn").onclick = async () => {
    const r = await fetch(CAPTURE, { method: "POST" });
    const data = await r.json();

    const div = document.getElementById("imageResult");
    div.innerHTML = `
      <div class="card p-3">
        <img src="${data.image_url}" class="media-box">
        <ul>${Object.entries(data.counts).map(([k,v])=>`<li>${k}: ${v}</li>`).join("")}</ul>
      </div>`;
  };

  document.getElementById("imageForm").onsubmit = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);

    const r = await fetch(UPLOAD_IMAGE, { method: "POST", body: fd });
    const data = await r.json();

    document.getElementById("imageResult").innerHTML = `
      <div class="card p-3">
        <img src="${data.image_url}" class="media-box">
        <ul>${Object.entries(data.counts).map(([k,v])=>`<li>${k}: ${v}</li>`).join("")}</ul>
      </div>`;

    let now = new Date().toLocaleTimeString();
    imgTimes.push(now);
    imgCounts.push(data.counts.person || 0);

    lineImg.data.labels = imgTimes;
    lineImg.data.datasets[0].data = imgCounts;
    lineImg.update();
  };

  document.getElementById("videoFormMain").onsubmit = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);

    document.getElementById("videoResult").innerHTML =
      `<div class="card p-3">Processing video...</div>`;

    const r = await fetch(UPLOAD_VIDEO, { method: "POST", body: fd });
    const data = await r.json();

    document.getElementById("videoResult").innerHTML = `
      <div class="card p-3">
        <video controls class="media-box"><source src="${data.video_url}"></video>
        <ul>${Object.entries(data.counts).map(([k,v])=>`<li>${k}: ${v}</li>`).join("")}</ul>
      </div>`;

    let now = new Date().toLocaleTimeString();
    vidTimes.push(now);
    vidCounts.push(data.counts.person || 0);

    lineVid.data.labels = vidTimes;
    lineVid.data.datasets[0].data = vidCounts;
    lineVid.update();
  };
</script>

</body>
</html>